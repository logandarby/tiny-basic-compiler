#!/bin/bash

# Pre-push hook for tiny-basic-compiler
# This hook will:
# 1. Build the project
# 2. Run the full test suite
# 3. Check that tests pass before allowing push

set -e

echo "ğŸš€ Running pre-push checks..."

# Change to project root
cd "$(git rev-parse --show-toplevel)"

# Build the project first
echo "ğŸ”¨ Building project..."
if ! make clean >/dev/null 2>&1; then
    echo "âš ï¸  Clean failed, continuing..."
fi

if ! make; then
    echo "âŒ Build failed! Cannot push with compilation errors."
    exit 1
fi

echo "âœ… Project builds successfully!"

# Check if we have tests
if [ -d "tests" ] && [ -n "$(find tests -name '*_test.c' -o -name '*_test.cpp' 2>/dev/null)" ]; then
    echo "ğŸ§ª Running test suite..."
    
    # Run tests
    if ! make test; then
        echo "âŒ Tests failed! Cannot push with failing tests."
        echo ""
        echo "ğŸ’¡ Fix the failing tests before pushing"
        exit 1
    fi
    
    echo "âœ… All tests passed!"
else
    echo "âš ï¸  No tests found in tests/ directory, skipping test run"
fi

# Additional checks for release builds
echo "ğŸ” Running additional checks..."

# Try building debug version
echo "ğŸ› Building debug version..."
if ! make debug >/dev/null 2>&1; then
    echo "âŒ Debug build failed!"
    exit 1
fi

echo "âœ… Debug build successful!"

# Check for any uncommitted changes that might affect the build
if ! git diff-index --quiet HEAD --; then
    echo "âš ï¸  You have uncommitted changes. Consider committing them first."
    echo "ğŸ“ Uncommitted files:"
    git diff-index --name-only HEAD --
    echo ""
    echo "â“ Do you want to continue with the push? (y/N)"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo "ğŸ›‘ Push cancelled"
        exit 1
    fi
fi

echo "âœ… Pre-push checks completed successfully!"
echo "ğŸš€ Proceeding with push..."
echo "" 